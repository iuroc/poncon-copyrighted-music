var baseUrl="";if(location.hostname=="localhost"){var baseUrl="http://web.app.ouyangpeng.top/poncon-copyrighted-music/"}var webTitle="无忧音乐网 - 海量无版权音乐共享";var userLoginDataKeyName="copyrighted_music_UserLoginData";var UserHasLogin=0;var nowFileId="";var nowPlayIndex=0;var request_updateFileList=request_getFileInfo=request_playMusic=request_addLike=request_secrahMusic=$.ajax();var neverLoad_getTypeList=0;var ap;function playMusic_v1(e,a){if(nowFileId==e){return}nowFileId=e;request_playMusic.abort();request_playMusic=$.ajax({method:"post",url:baseUrl+"api/getMusicInfo.php",data:{fileId:e},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e.code==200){a=$(a).parent().find("span.listen_num");a.html(parseInt(a.text())+1);$(".aplayerBox, .goDownloadMusicGood").show().css("position","fixed");ap=new APlayer({container:document.getElementById("aplayer"),audio:[{name:e.result.fileName.replace(/(.*).mp3$/,"$1"),artist:"无忧音乐网",url:e.result.downloadUrl,cover:"img/music.jpg",theme:"#525288"}]});ap.play()}else{alert(e.msg)}}})}function playMusic(e,s){var t=s.find(".musicList-item");var a=[];nowPlayIndex=e;for(var i=0;i<t.length;i++){var n=$(t[i]);a.push({name:n.find("h5").text(),artist:"无忧音乐网",url:baseUrl+"api/playMusic.php?fileId="+n.data("fileid"),cover:"img/music.jpg",theme:"#525288"})}var o=s.find(".musicList-item")[e];ele_listen_num=$(o).find("span.listen_num");ele_listen_num.html(parseInt(ele_listen_num.text())+1);$(".aplayerBox, .goDownloadMusicGood").show().css("position","fixed");ap=new APlayer({listFolded:$(".aplayer-list").css("height")=="0px"||!$(".aplayer-list").css("height"),container:document.getElementById("aplayer"),audio:a});ap.list.switch(e);ap.play();ap.on("listswitch",function(e){var a=e.index;var i=s.find(".musicList-item")[a];ele_listen_num=$(i).find("span.listen_num");ele_listen_num.html(parseInt(ele_listen_num.text())+1);$(".musicList .active").removeClass("active");$(t[a]).addClass("active");nowPlayIndex=a});ap.on("listshow",function(){$(".container-main").css("margin-bottom","205px")});ap.on("listhide",function(){$(".container-main").css("margin-bottom","80px")})}function getUserInfo(e){try{var a=JSON.parse(localStorage[userLoginDataKeyName]);return a[e]}catch(e){return null}}function getListHtml(e){for(var a=0,i="";a<e.length;a++){if(e[a].hasLike){var s='<span class="addLike cursor cursor-warning text-warning" data-haslike="1"><span class="bi bi bi-star-fill"></span><span class="like_num">'+e[a].like_num+"</span></span>"}else{var s='<span class="addLike cursor cursor-warning" data-haslike="0"><span class="bi bi bi-star"></span><span class="like_num">'+e[a].like_num+"</span></span>"}i+='<div class="col-xl-3 col-lg-4 col-md-6"><div class="p-3 rounded shadow border mb-4 musicList-item file-'+e[a].fileId+'" data-fileid="'+e[a].fileId+'"><h5 class="pb-2 mb-0 text-mainColor cursor">'+e[a].fileName.replace(/(.*).mp3$/,"$1")+'</h5><div class="msg text-muted cursor small mb-2">'+e[a].msg+'</div><div class="text-info small mb-2">#'+e[a].musicType+'</div><div class="text-nowrap overflow-hidden"><span class="bi bi-headphones"></span><span class="listen_num mr-3 mr-sm-2">'+e[a].listen_num+'</span><span class="bi bi-filetype-mp3"></span><span class="fileSize mr-3 mr-sm-2">'+fileSize(e[a].size)+"</span>"+s+"</div></div></div>"}return i}function loadMusicList(s,t,n){if(t==0){$(".page-musicList .musicList").html("")}$(".page-musicList .loadMore").hide();$(".page-musicList .loading").show();$(".page-musicList .loadMore button").show();$.ajax({method:"post",url:baseUrl+"api/getMusicList.php",data:{type:s,page:t,pageSize:n,username:getUserInfo("username"),password:getUserInfo("password")},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){$(".page-musicList .loading").hide();$(".page-musicList .loadMore").show();if(e.code==200){var a=e.result;if(a.length==0){$(".page-musicList .loadMore button").hide();return}var i=getListHtml(a);$(".page-musicList .musicList").append(i);$(".page-musicList .loadMore button").unbind().click(function(){loadMusicList(s,++t,n)});addClick("musicList")}else{alert(e.msg)}}})}function fileSize(e){var a=["B","KB","MB","GB","TB","PB"];var i=1024;for(var s=0;s<a.length;s++){if(e<i){return(s==0?e:e.toFixed(2))+a[s]}e/=i}}function loadUserLikeList(e,a){if(e==0){$(".page-user .musicList").html("")}$(".page-user .loadMore").hide();$(".page-user .loading").show();$(".page-user .loadMore button").show();$(".page-user .loadMore button").unbind().click(function(){loadUserLikeList(++e,a)});$.ajax({method:"post",url:baseUrl+"api/getUserLikeList.php",data:{page:e,pageSize:a,username:getUserInfo("username"),password:getUserInfo("password")},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){$(".page-user .loading").hide();$(".page-user .loadMore").show();if(e.code==200){var a=e.result;if(a.length==0){$(".page-user .loadMore button").hide()}var i=getListHtml(a);$(".page-user .musicList").append(i);addClick("user")}else{alert(e.msg)}}})}function addClick(s){$(".page-"+s+" .musicList .file-"+nowFileId).addClass("active");$(".page-"+s+" .musicList-item h5, .page-"+s+" .musicList-item .msg").unbind().click(function(){$(".page-"+s+" .musicList .active").removeClass("active");$(this).parent().addClass("active");var e=$(this).parent().parent().index();playMusic(e,$(".page-"+s+" .musicList"))});$(".page-"+s+" .musicList-item span.addLike").unbind().click(function(){if(!UserHasLogin){location.hash="/login/";return}var e=$(this).attr("data-haslike");if(parseInt(e)){if(!confirm("确定要取消收藏？")){return}}var a=$(this).parent().parent().data("fileid");var i=$(this);request_addLike.abort();request_addLike=$.ajax({method:"post",url:baseUrl+"api/addLikeNum.php",data:{fileId:a,username:getUserInfo("username"),password:getUserInfo("password")},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e.code==200){if(e.type){i.removeClass("text-warning");i.find(".bi-star-fill").removeClass("bi-star-fill").addClass("bi-star");var a=i.find(".like_num");a.html(parseInt(a.text())-1);i.attr("data-haslike",0);if(s=="user"){loadUserLikeList(0,36)}}else{i.addClass("text-warning");i.find(".bi-star").removeClass("bi-star").addClass("bi-star-fill");var a=i.find(".like_num");a.html(parseInt(a.text())+1);i.attr("data-haslike",1)}}else{alert(e.msg)}}})})}function router(e){scrollTo(0,0);e=e.split("/");var a=e[1];$(".page-oyp").hide();var i=$(".page-"+a);i.fadeIn();$(".navbar-collapse li.active").removeClass("active");$(".navbar-collapse li.nav-item-"+a).addClass("active");if(a=="home"){document.title=webTitle;$.ajax({method:"post",url:baseUrl+"api/getMusicList.php",data:{type:"all",page:0,pageSize:36,username:getUserInfo("username"),password:getUserInfo("password")},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e.code==200){var a=e.result;var i=getListHtml(a);$(".page-home .musicList").html(i);addClick("home")}else{alert(e.msg)}}});if(neverLoad_getTypeList){return}$.ajax({method:"get",url:baseUrl+"api/getTypeList.php",contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(i){neverLoad_getTypeList=1;var e="";for(var a=0;a<i.length;a++){e+='<div class="col-xl-3 col-lg-4 col-6"><div data-index="'+a+'" class="rounded shadow border p-3 mb-4 border-mainColor text-center musicTypeList-item '+(a==0?"musicTypeList-item-active":"")+'"><div class="overflow-hidden"><h5 class="text-mainColor mb-0 text-nowrap text-truncate">'+i[a][1]+'</h5><div class="msg text-nowrap text-truncate">'+i[a][0]+"</div></div></div></div>"}$(".page-home .musicTypeList").html(e);$(".page-home .musicTypeList .musicTypeList-item").unbind().click(function(){var e=$(this).data("index");var a=i[parseInt(e)];location.hash="/musicList/"+encodeURIComponent(a[0])+"/"+encodeURIComponent(a[1])+"/"})}})}else if(a=="about"){document.title="关于 - "+webTitle}else if(a=="search"){document.title="音乐搜索 - "+webTitle}else if(a=="login"){if(e[2]=="register"){i.find("input").val("");i.find(".page-sub-register").show();i.find(".title").html("用户注册");document.title="用户注册 - "+webTitle}else{i.find(".page-sub-login").show();i.find(".title").html("用户登录");document.title="用户登录 - "+webTitle}}else if(a=="musicList"){var s=decodeURIComponent(e[2]);var t=decodeURIComponent(e[3]);document.title=t+" - 音乐列表 - "+webTitle;$(".page-musicList .breadcrumb .active").html(t+" - 音乐列表");loadMusicList(s,0,36)}else if(a=="user"){document.title="我的收藏 - "+webTitle;if(!UserHasLogin&&!ifLogin()){location.hash="/login/";return}loadUserLikeList(0,36)}else{location.hash="/home/"}}window.addEventListener("hashchange",function(e){var a=new URL(e.newURL).hash;router(a)});function hasLogin(){UserHasLogin=1;$(".navbar-collapse li.nav-item-login").hide();$(".navbar-collapse li.nav-item-logout").show()}function notLogin(){UserHasLogin=0;$(".navbar-collapse li.nav-item-logout").hide();$(".navbar-collapse li.nav-item-login").show()}function ifLogin(){try{var e=JSON.parse(localStorage[userLoginDataKeyName]);if(e.username&&e.password&&e.email){var a=0;$.ajax({url:baseUrl+"api/login.php",method:"post",data:{username:e.username,password:e.password},success:function(e){if(e.code==200){hasLogin();localStorage[userLoginDataKeyName]=JSON.stringify(e.result);a=1}else{notLogin();a=0}},async:false});if(a){return true}else{return false}}else{notLogin();return false}}catch(e){notLogin();return false}}function searchMusic(e,a,i){if(a==0){$(".page-search .musicList").html("")}$(".page-search .loadMore").hide();$(".page-search .loading").show();$(".page-search .loadMore button").show();$(".page-search .loadMore button").unbind().click(function(){searchMusic(e,++a,i)});request_secrahMusic.abort();request_secrahMusic=$.ajax({method:"post",url:baseUrl+"api/searchMusic.php",data:{page:a,pageSize:i,keyword:e,username:getUserInfo("username"),password:getUserInfo("password")},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){$(".page-search .loading").hide();$(".page-search .loadMore").show();if(e.code==200){var a=e.result;if(a.length==0){$(".page-search .loadMore button").hide()}var i=getListHtml(a);$(".page-search .musicList").append(i);addClick("search")}else{alert(e.msg)}}})}$(document).ready(function(){console.log("%cHello Poncon 2022-05-07","color: orange; border: 2px solid orange; padding: 2px 4px; font-size: 16px;");if(!location.hash.split("/")[1]){history.replaceState({},null,"#/home/")}router(location.hash);ifLogin();function s(e,a){e.username=$(".page-login .page-sub-register .input-username").val();e.email=$(".page-login .page-sub-register .input-email").val();e.password=$(".page-login .page-sub-register .input-password").val();var i=$(".page-login .page-sub-register .input-password2").val();e.verCode=$(".page-login .page-sub-register .input-verCode").val();if(!e.username.match(/^\w{4,20}$/)){alert("用户名要求长度为4-20，只能包含数字、字母和下划线");return false}else if(!e.email.match(/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/)){alert("邮箱不合法");return false}else if(!e.password.match(/^\w{8,20}$/)){alert("密码要求长度为8-20，只能包含数字、字母和下划线");return false}else if(e.password!=i){alert("两次输入的密码不一致");return}else if(!e.verCode&&a==1){alert("请输入验证码");return false}return true}$(".page-login .page-sub-register button.register").click(function(){var e={};if(!s(e,1)){return}var a=e.username;var i=e.password;$.ajax({method:"post",url:baseUrl+"api/register.php",data:{username:a,password:md5(i),email:e.email,verCode:e.verCode},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e.code==200){location.hash="/login/";console.log(a,i);$(".page-login .page-sub-login .input-username").val(a);$(".page-login .page-sub-login .input-password").val(i)}else{}alert(e.msg)}})});$(".page-login .page-sub-register button.getVerCode").click(function(){var e={};if(!s(e,2)){return}var i=$(this);i.attr("disabled","disabled");$.ajax({method:"post",url:baseUrl+"api/getCode.php",data:{email:e.email},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e.code==200){for(var a=0;a<60;a++){(function(e){setTimeout(function(){i.html(60-e+"秒后重新获取")},1e3*e)})(a)}setTimeout(()=>{i.removeAttr("disabled");i.html("获取验证码")},1e3*60)}else{alert(e.msg);i.removeAttr("disabled");i.html("获取验证码")}}})});$(".page-login .page-sub-login button.login").click(function(){var e=$(".page-login .page-sub-login .input-username").val();var a=$(".page-login .page-sub-login .input-password").val();if(!e||!a){alert("账号和密码不能为空");return}else if(!e.match(/^\w{4,20}$/)&&!e.match(/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/)||!a.match(/^\w{8,20}$/)){alert("账号或密码格式错误");return}$.ajax({method:"post",url:baseUrl+"api/login.php",data:{username:e,password:md5(a)},contentType:"application/x-www-form-urlencoded",dataType:"json",success:function(e){if(e.code==200){localStorage[userLoginDataKeyName]=JSON.stringify(e.result);location.hash="/home/";hasLogin()}else{alert(e.msg)}}})});$(".page-login .page-sub-login .input-password").bind("keyup",function(e){if(e.keyCode==13){$(this).blur();$(".page-login .page-sub-login button.login").click()}});$(".page-login .page-sub-register .input-verCode").bind("keyup",function(e){if(e.keyCode==13){$(this).blur();$(".page-login .page-sub-register button.getVerCode").click()}});$(".nav-item-logout").click(function(){if(!confirm("确定要退出登录吗？")){return}localStorage[userLoginDataKeyName]="";notLogin()});$("span.goDownloadMusicGood").click(function(){if(UserHasLogin){var e=ap.options.audio[nowPlayIndex].url;$(".download_iframes").append('<iframe src="'+e+'"></iframe>');$(".modal-msg").modal("show")}else{location.hash="/login/"}});$("body").show();$("a").attr("draggable","false");new ClipboardJS(".copybtn");$(".page-search button.search").click(function(){var e=$(".page-search input.keyword").val();if(e){searchMusic(e,0,36)}});$(".page-search input.keyword").bind("keyup",function(e){if(e.keyCode=="13"){$(".page-search input.keyword").blur();$(".page-search button.search").click()}});$(".navbar-collapse li").click(function(){var e=$(".navbar button.navbar-toggler");if(e.css("display")=="block"){$(".navbar button.navbar-toggler").click()}})});